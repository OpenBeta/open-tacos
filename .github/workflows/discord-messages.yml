name: Discord Notification
on:
  push:
    branches: [discord-opentacos]
  pull_request:
    branches: [discord-opentacos]
  # issues:
  #   types: [opened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if first-time contributor
        id: check
        run: echo "::set-output name=first_time_contributor::$(if [ $(git log --pretty=format:"%ae" | sort -u | grep -c ${{ github.event.pull_request.user.login }}) -eq 1 ]; then echo 'true'; else echo 'false'; fi)"

      - name: Set PR Message
        id: pr_msg
        run: echo "::set-output name=message::Congratulations to the first-time contributor for their pull request! ðŸŽ‰"
        if: github.event_name == 'pull_request' && github.event.action == 'opened' && steps.check.outputs.first_time_contributor == 'true'

      - name: Set Merge Message
        id: merge_msg
        run: echo "::set-output name=message::Congratulations to the first-time contributor for their successful merge! ðŸŽ‰"
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && steps.check.outputs.first_time_contributor == 'true' && github.event.pull_request.merged == 'true'

      - name: Set Push Message
        id: push_msg
        run: echo "::set-output name=message::A new commit has been pushed to the main branch."
        if: github.event_name == 'push'

      - name: Actions for Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        uses: "Ilshidur/action-discord@0c4b27844ba47cb1c7bee539c8eead5284ce9fa9"
        with:
          args: >-
            ${{ steps.pr_msg.outputs.message || steps.merge_msg.outputs.message || steps.push_msg.outputs.message || 'There is some activity in the repository!' }}
